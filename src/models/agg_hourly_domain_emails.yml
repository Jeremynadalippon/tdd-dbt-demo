unit_tests:
    - name: test_group_by_hour
      description: It groups by hour
      model: agg_hourly_domain_emails
      given:
        - input: ref('fact_emails')
          rows:
            - { received_at: '2021-01-01 00:00:00' }
            - { received_at: '2021-01-01 00:30:00' }
            - { received_at: '2021-01-01 01:00:00' }
            - { received_at: '2021-01-02 00:00:00' }
      expect:
        rows:
          - { sent_at_hour: '2021-01-01 00:00:00', email_count: 2 }
          - { sent_at_hour: '2021-01-01 01:00:00', email_count: 1 }
          - { sent_at_hour: '2021-01-02 00:00:00', email_count: 1 }

    - name: test_group_by_domain
      description: It groups by domain
      model: agg_hourly_domain_emails
      given:
        - input: ref('fact_emails')
          rows:
            - { sender_address: 'toto@ippon.fr' }
            - { sender_address: 'titi@ippon.fr' }
            - { sender_address: 'tata@google.com' }
      expect:
        rows:
          - { domain: 'ippon.fr', email_count: 2 }
          - { domain: 'google.com', email_count: 1 }

    - name: test_group_by_domain_hour
      description: It groupss by domain and hour
      model: agg_hourly_domain_emails
      given:
        - input: ref('fact_emails')
          rows:
            - { sender_address: 'toto@ippon.fr', received_at: '2021-01-01 00:00:00' }
            - { sender_address: 'titi@ippon.fr', received_at: '2021-01-01 00:30:00' }
            - { sender_address: 'tata@google.com', received_at: '2021-01-01 00:00:00' }
            - { sender_address: 'tata@google.com', received_at: '2021-01-01 01:00:00' }
      expect:
        rows:
          - { domain: 'ippon.fr', sent_at_hour: '2021-01-01 00:00:00', email_count: 2 }
          - { domain: 'google.com', sent_at_hour: '2021-01-01 00:00:00', email_count: 1 }
          - { domain: 'google.com', sent_at_hour: '2021-01-01 01:00:00', email_count: 1 }